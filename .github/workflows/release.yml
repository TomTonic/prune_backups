name: Build and Release Go Executables

on:
  push:
    tags:
      - 'v*' # Triggers on tags like v1.0.0

permissions:
  contents: read

jobs:
  build:
    name: Build and Release
    # Declare default permissions as write to be allowed to publich artifacts.
    permissions:
      contents: write
    runs-on: ubuntu-latest
#    strategy:
#      matrix:
#        goos: [linux, windows, darwin]
#        goarch: [amd64, arm64]
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout Code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod

      - name: Build Executable
        run: |
          mkdir -p dist
          GOOS=linux GOARCH=amd64 go build -o dist/prune_backups-amd64-linux .
          GOOS=linux GOARCH=arm64 go build -o dist/prune_backups-arm64-linux .
          GOOS=linux GOARCH=386 go build -o dist/prune_backups-x86-linux .
          GOOS=linux GOARCH=arm go build -o dist/prune_backups-arm-linux .
          GOOS=windows GOARCH=amd64 go build -o dist/prune_backups-amd64-win.exe .
          GOOS=windows GOARCH=arm64 go build -o dist/prune_backups-arm64-win.exe .
          GOOS=windows GOARCH=386 go build -o dist/prune_backups-x86-win.exe .
          GOOS=darwin GOARCH=amd64 go build -o dist/prune_backups-amd64-mac .
          GOOS=darwin GOARCH=arm64 go build -o dist/prune_backups-arm64-mac .
#          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build -o dist/prune_backups-${{ matrix.goos }}-${{ matrix.goarch }} .

#      - name: Create Debian Package
#        run: |
#          mkdir -p debian/DEBIAN
#          echo "Package: prune_backups" > debian/DEBIAN/control
#          echo "Version: 1.0.0" >> debian/DEBIAN/control
#          echo "Architecture: amd64" >> debian/DEBIAN/control
#          echo "Maintainer: Your Name <you@example.com>" >> debian/DEBIAN/control
#          echo "Description: Prune Backups Tool" >> debian/DEBIAN/control
#          mkdir -p debian/usr/local/bin
#          cp dist/prune_backups-amd64-linux debian/usr/local/bin/prune_backups
#          dpkg-deb --build debian prune_backups_1.0.0_amd64.deb
#          mv prune_backups_1.0.0_amd64.deb dist/

#      - name: Create RPM Package
#        run: |
#          mkdir -p rpm/SPECS
#          echo "Name: prune_backups" > rpm/SPECS/prune_backups.spec
#          echo "Version: 1.0.0" >> rpm/SPECS/prune_backups.spec
#          echo "Release: 1%{?dist}" >> rpm/SPECS/prune_backups.spec
#          echo "Summary: Prune Backups Tool" >> rpm/SPECS/prune_backups.spec
#          echo "License: MIT" >> rpm/SPECS/prune_backups.spec
#          echo "Source0: %{name}-%{version}.tar.gz" >> rpm/SPECS/prune_backups.spec
#          echo "%description" >> rpm/SPECS/prune_backups.spec
#          echo "Prune Backups Tool" >> rpm/SPECS/prune_backups.spec
#          mkdir -p rpm/SOURCES
#          tar -czf rpm/SOURCES/prune_backups-1.0.0.tar.gz -C dist prune_backups-amd64-linux
#          rpmbuild -ba rpm/SPECS/prune_backups.spec
#          mv ~/rpmbuild/RPMS/x86_64/prune_backups-1.0.0-1.x86_64.rpm dist/

#      - name: Create MSI Installer
#        run: |
#          mkdir -p msi
#          echo "Product: Prune Backups" > msi/product.wxs
#          echo "Version: 1.0.0" >> msi/product.wxs
#          echo "Manufacturer: Your Name" >> msi/product.wxs
#          echo "Executable: dist/prune_backups-amd64-win.exe" >> msi/product.wxs
#          candle msi/product.wxs
#          light -out dist/prune_backups-amd64-win.msi msi/product.wixobj

#      - name: Create Homebrew Formula
#        run: |
#          echo "class PruneBackups < Formula" > dist/prune_backups.rb
#          echo "  desc \"Prune Backups Tool\"" >> dist/prune_backups.rb
#          echo "  homepage \"https://example.com\"" >> dist/prune_backups.rb
#          echo "  url \"file://#{Dir.pwd}/dist/prune_backups-amd64-mac\"" >> dist/prune_backups.rb
#          echo "  version \"1.0.0\"" >> dist/prune_backups.rb
#          echo "  def install" >> dist/prune_backups.rb
#          echo "    bin.install \"prune_backups-amd64-mac\"" >> dist/prune_backups.rb
#          echo "  end" >> dist/prune_backups.rb

      - name: Upload Release Assets
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          files: |
            dist/prune_backups-*
#            dist/prune_backups.rb
